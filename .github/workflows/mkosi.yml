name: mkosi

# Simple boot tests that build and boot the mkosi images generated by the mkosi config files in .mkosi.

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        distro:
          - arch
          - debian
          - ubuntu
          - fedora
          - opensuse

    steps:
    - uses: actions/checkout@v2
    - uses: Werkov/mkosi@opensuse-github

    - name: Install
      run: sudo apt-get update && sudo apt-get install --no-install-recommends python3-pexpect

    # glibc 2.33-3 shipped on 2021-02-06 breaks running Arch containers on
    # systems with older kernels (like Ubuntu Focal). Until the issue is
    # resolved, let's pin the Arch repositories to glibc 2.32-5 to mitigate
    # the annoying CI fails.
    #
    # See: https://bugs.archlinux.org/task/69563
    - name: Pin repositories to 2021-02-05
      run: sed -i '/^\[Distribution\]/aMirror=https://archive.archlinux.org/repos/2021/02/05/' .mkosi/mkosi.arch

    - name: Symlink
      run: ln -s .mkosi/mkosi.${{ matrix.distro }} mkosi.default

    - name: Build ${{ matrix.distro }}
      run: sudo python3 -m mkosi --password= --network-veth=no --qemu-headless build

    - name: Boot ${{ matrix.distro }} systemd-nspawn
      run: sudo ./.github/workflows/test_mkosi_boot.py python3 -m mkosi --password= --network-veth=no --qemu-headless boot

    - name: Boot ${{ matrix.distro }} QEMU
      run: sudo ./.github/workflows/test_mkosi_boot.py python3 -m mkosi --password= --network-veth=no --qemu-headless qemu
