<?xml version='1.0'?> <!--*-nxml-*-->
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->

<refentry id="systemd.devlink" conditional='ENABLE_DEVLINKD'
          xmlns:xi="http://www.w3.org/2001/XInclude">

  <refentryinfo>
    <title>systemd.devlink</title>
    <productname>systemd</productname>
  </refentryinfo>

  <refmeta>
    <refentrytitle>systemd.devlink</refentrytitle>
    <manvolnum>5</manvolnum>
  </refmeta>

  <refnamediv>
    <refname>systemd.devlink</refname>
    <refpurpose>Devlink object configuration</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <para><filename><replaceable>devlink</replaceable>.devlink</filename></para>
  </refsynopsisdiv>

  <refsect1>
    <title>Description</title>

    <para>A plain ini-style text file that encodes configuration of a devlink object, used by
    <citerefentry><refentrytitle>systemd-devlinkd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
    See <citerefentry><refentrytitle>systemd.syntax</refentrytitle><manvolnum>7</manvolnum></citerefentry>
    for a general description of the syntax.</para>

    <para>The main devlink object configuration file must have the extension <filename>.devlink</filename>;
    other extensions are ignored. Devlink objects are configured as soon as
    <command>systemd-devlinkd</command> is started if possible. In case they are not present
    at start, they are configured as they appear one by one.</para>

    <para>The <filename>.devlink</filename> files are read from the files located in the system devlink
    directory <filename>/usr/lib/systemd/devlink</filename> and
    <filename>/usr/local/lib/systemd/devlink</filename>, the volatile runtime devlink directory
    <filename>/run/systemd/devlink</filename> and the local administration devlink directory
    <filename>/etc/systemd/devlink</filename>. All configuration files are collectively sorted and
    processed in alphanumeric order, regardless of the directories in which they live. However, files
    with identical filenames replace each other. Files in <filename>/etc/</filename> have the
    highest priority, files in <filename>/run/</filename> take precedence over files with the same name
    in <filename>/usr/lib/</filename>. This can be used to override a system-supplied configuration
    file with a local file if needed. As a special case, an empty file (file size 0) or symlink with
    the same name pointing to <filename>/dev/null</filename> disables the configuration file entirely
    (it is "masked").</para>

    <para>Along with the devlink file <filename>foo.devlink</filename>, a "drop-in" directory
    <filename>foo.devlink.d/</filename> may exist. All files with the suffix <literal>.conf</literal>
    from this directory will be merged in the alphanumeric order and parsed after the main file itself
    has been parsed. This is useful to alter or add configuration settings, without having to modify
    the main configuration file. Each drop-in file must have appropriate section headers.</para>

    <para>In addition to <filename>/etc/systemd/devlink</filename>, drop-in <literal>.d</literal>
    directories can be placed in <filename>/usr/lib/systemd/devlink</filename> or
    <filename>/run/systemd/devlink</filename> directories. Drop-in files in
    <filename>/etc/</filename> take precedence over those in <filename>/run/</filename> which in turn
    take precedence over those in <filename>/usr/lib/</filename>. Drop-in files under any of these
    directories take precedence over the main devlink file wherever located. (Of course, since
    <filename>/run/</filename> is temporary and <filename>/usr/lib/</filename> is for vendors, it is
    unlikely drop-ins should be used in either of those places.)</para>
  </refsect1>

  <refsect1>
    <title>Supported devlink object kinds</title>

    <para>The following kinds of devlink objects may be
    configured by <filename>.devlink</filename> files:</para>

    <table>
      <title>Supported kinds of devlink objects</title>

      <tgroup cols='2'>
        <colspec colname='kind' />
        <colspec colname='explanation' />
        <thead><row>
          <entry>Kind</entry>
          <entry>Description</entry>
          <entry>Match keys</entry>
        </row></thead>
        <tbody>
          <row><entry><varname>dev</varname></entry>
          <entry>A main devlink object representing the device on a bus (e. g. PCI).</entry>
          <entry><simplelist type="vert">
            <member><literal>Handle</literal></member>
          </simplelist></entry></row>
        </tbody>
        <tbody>
          <row><entry><varname>port</varname></entry>
          <entry>An object representing port, could be physical port, or for example an E-Switch link to VF.</entry>
          <entry><simplelist type="vert">
            <member><literal>Handle</literal>, <literal>Index</literal> and <literal>Split</literal></member>
            <member><literal>Handle</literal> and <literal>Index</literal></member>
            <member><literal>NetdevName</literal></member>
          </simplelist></entry></row>
        </tbody>
        <tbody>
          <row><entry><varname>param</varname></entry>
          <entry>An object representing param, could be either dev param or port param.</entry>
          <entry><simplelist type="vert">
            <member><literal>Handle</literal> and <literal>Name</literal></member>
            <member><literal>Handle</literal>, <literal>Index</literal>, <literal>Split</literal> and <literal>Name</literal></member>
            <member><literal>NetdevName</literal> and <literal>Name</literal></member>
          </simplelist></entry></row>
        </tbody>
      </tgroup>
    </table>
  </refsect1>

  <refsect1>
    <title>[Match] Section Options</title>

    <para>The [Match] section allows to specify keys upon which the kernel
    devlink objects are matched. All specified keys have to match.
    The [Match] section accepts the following keys:</para>

    <variablelist class='network-directives'>
      <varlistentry>
        <term><varname>Kind=</varname></term>
        <listitem>
          <para>The devlink object kind. This setting is compulsory. See the
          <literal>Supported devlink object kinds</literal> section for the
          valid options.</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term><varname>Handle=</varname></term>
        <listitem>
          <para>The devlink handle. The format is <literal>BUS_NAME/DEV_NAME</literal>,
          for example <literal>pci/0000:01:00.0</literal></para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term><varname>Index=</varname></term>
        <listitem>
          <para>Object index, serves to some object kinds (e. g. port)
          to identify some object. Takes a number in the range 1…4294967296.</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term><varname>NetdevName=</varname></term>
        <listitem>
          <para>Name of a netdevice associated with devlink port.</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term><varname>Split=</varname></term>
        <listitem>
          <para>Takes a boolean. When true, matches on a port which is split.
          If omitted, the value is defaulted to false and matches on
          a non-split port.</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term><varname>Name=</varname></term>
        <listitem>
          <para>Name of an object to identify it (e. g. param).</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>[Dev] Section Options</title>

    <para>The [Dev] section only applies for
    devlink objects of kind <literal>dev</literal>, and accepts the
    following key:</para>

    <variablelist class='network-directives'>
      <varlistentry>
        <term><varname>EswitchMode=</varname></term>
        <listitem>
          <para>The E-Switch mode to use. The supported options are
          <literal>legacy</literal>, and
          <literal>switchdev</literal>.
          </para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>[Port] Section Options</title>

    <para>The [Port] section only applies for
    devlink objects of kind <literal>port</literal>, and accepts the
    following key:</para>

    <variablelist class='network-directives'>
      <varlistentry>
        <term><varname>SplitCount=</varname></term>
        <listitem>
          <para>Instructs the port to split into multiple ones. Takes a number
          in the range 1…4294967296, usually power of 2.</para>
          <para>Note that the matched port disappears and new ports appear. To match on
          them, one has to use <literal>Split=true</literal> in [Match] section. </para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>[Param] Section Options</title>

    <para>The [Param] section only applies for
    devlink objects of kind <literal>param</literal>, and accepts the
    following key:</para>

    <variablelist class='network-directives'>
      <varlistentry>
        <term><varname>Value=</varname></term>
        <listitem>
          <para>Instructs the param value to be set. The format depends on the param type. In case
          the param <literal>cmode</literal> is <literal>driverinit</literal>, devlink reload
          it invoked after new param value is set.</para>

        <xi:include href="version-info.xml" xpointer="v258"/>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>

  <refsect1>
    <title>Examples</title>
    <example>
      <title>/etc/systemd/devlinkd/10-eswitch-mode.devlink</title>

      <programlisting>[Match]
Kind=dev
Handle=pci/0000:01:00.0

[Dev]
EswitchMode=switchdev</programlisting>
    </example>
    <example>
      <title>/etc/systemd/devlinkd/10-port-split.devlink</title>

      <programlisting>[Match]
Kind=port
Handle=pci/0000:01:00.0
Index=1

[Port]
SplitCount=4</programlisting>
    </example>
    <example>
      <title>/etc/systemd/devlinkd/10-ifname-port-split.devlink</title>

      <programlisting>[Match]
Kind=port
NetdevName=enp0s1np1

[Port]
SplitCount=4</programlisting>
    </example>
    <example>
      <title>/etc/systemd/devlinkd/10-param-rehash-interval.devlink</title>

      <programlisting>[Match]
Kind=param
Handle=pci/0000:01:00.0
Name=acl_region_rehash_interval</programlisting>
    </example>
    <example>
      <title>/etc/systemd/devlinkd/10-param-port-keep-link-up.devlink</title>

      <programlisting>[Match]
Kind=param
NetdevName=enp0s1np1
Name=keep_link_up

[Param]
Value=false</programlisting>
    </example>
  </refsect1>

  <refsect1>
    <title>See Also</title>
    <para><simplelist type="inline">
      <member><citerefentry><refentrytitle>systemd</refentrytitle><manvolnum>1</manvolnum></citerefentry></member>
      <member><citerefentry><refentrytitle>systemd-devlinkd.service</refentrytitle><manvolnum>8</manvolnum></citerefentry></member>
    </simplelist></para>
  </refsect1>

</refentry>
